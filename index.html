<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creator</title>
    <meta name="theme-color" content="#4285f4"/>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Menu HTML -->
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="overlay" id="overlay"></div>
    <nav class="nav-panel" id="nav-panel">
        <ul>
            <li><a href="./how-to.html">How to Create a File?</a></li>
            <li><a href="https://360pwatcher.github.io/Anilist/" target="_blank">Contact Us</a></li>
        </ul>
    </nav>
    
    <main>
        <!-- Section 1: Hero Landing Page -->
        <div id="hero-section" class="hero-section">
            <div class="hero-content">
                <h1>CREATE A QUIZ</h1>
                <p>Build your own interactive quizzes with ease.</p>
                <a href="#" id="show-creator-btn" class="button-style">Create Quiz</a>
            </div>
            <img src="./hero-image.svg" alt="Quiz illustration" class="hero-image">
            <div id="quiz-counter-display" style="margin-top: 2rem; color: var(--secondary-text-color);">
                <span id="total-quizzes">...</span> quizzes created so far!
            </div>
        </div>
        
        <!-- All other sections (creator, quiz-view, etc.) remain the same -->
        <div id="creator-section" style="display: none;">
            <!-- ... creator content ... -->
        </div>
        <div id="quiz-view" style="display: none;">
            <!-- ... quiz player content ... -->
        </div>
        <div id="results-view" style="display: none;">
            <!-- ... results content ... -->
        </div>
    </main>

    <!-- THE SINGLE, COMPLETE, AND CORRECTED SCRIPT BLOCK -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SUPABASE SETUP ---
            const supabaseUrl = 'https://ckjtmhsolnjjmxxndslv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNranRtaHNvbG5qam14eG5kc2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDEyMTgsImV4cCI6MjA2NzIxNzIxOH0.wADqu8wQHy5rWT6pHFaGK-kVEapXCsNxVM27iwg-5I8';
            const { createClient } = window.supabase;
            const supabase = createClient(supabaseUrl, supabaseKey);

            // --- DOM REFERENCES ---
            const heroSection = document.getElementById('hero-section');
            const creatorSection = document.getElementById('creator-section');
            const quizView = document.getElementById('quiz-view');
            const resultsView = document.getElementById('results-view');
            const showCreatorBtn = document.getElementById('show-creator-btn');
            const questionsContainer = document.getElementById('questions-container');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const generateManualBtn = document.getElementById('generate-manual-btn');
            const fileInput = document.getElementById('quiz-file-input');
            const createFileBtn = document.getElementById('create-from-file-btn');
            const linkContainer = document.getElementById('share-link-container');
            const shareLinkInput = document.getElementById('share-link');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const menuToggle = document.getElementById('menu-toggle');
            const navPanel = document.getElementById('nav-panel');
            const overlay = document.getElementById('overlay');
            const body = document.body;
            const quizCounterDisplay = document.getElementById('total-quizzes');

            // --- GLOBAL STATE ---
            let quizDataForOfflinePlay = [];
            
            // --- MENU LOGIC ---
            function closeMenu() { menuToggle.classList.remove('is-active'); navPanel.classList.remove('open'); overlay.classList.remove('open'); body.classList.remove('no-scroll'); }
            menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('is-active'); navPanel.classList.toggle('open'); overlay.classList.toggle('open'); body.classList.toggle('no-scroll'); });
            overlay.addEventListener('click', closeMenu);

            // --- VIEW SWITCHING LOGIC ---
            showCreatorBtn.addEventListener('click', (e) => { e.preventDefault(); heroSection.style.display = 'none'; creatorSection.style.display = 'block'; });

            // --- NEW, RELIABLE COUNTER LOGIC ---
            async function updateQuizCount() {
                try {
                    // Ask Supabase for the total count of rows in the 'quizzes' table
                    const { count, error } = await supabase
                        .from('quizzes')
                        .select('*', { count: 'exact', head: true });

                    if (error) {
                        throw error;
                    }
                    
                    quizCounterDisplay.textContent = count;

                } catch (error) {
                    console.error("Error fetching quiz count from Supabase:", error.message);
                    quizCounterDisplay.textContent = 'N/A';
                }
            }

            // --- QUIZ CREATOR FUNCTIONS ---
            async function generateAndSaveQuiz(data) {
                quizDataForOfflinePlay = data;
                if (!data || data.length === 0) { alert("No valid questions found."); return; }
                
                const quizId = Date.now().toString(36) + Math.random().toString(36).substring(2, 7);
                linkContainer.style.display = 'block';
                shareLinkInput.value = 'Saving to cloud...';
                startQuizBtn.style.pointerEvents = 'none';

                try {
                    const { error } = await supabase.from('quizzes').insert({ short_id: quizId, data: data });
                    if (error) { throw error; }
                    
                    const baseUrl = window.location.href.replace('index.html', '').replace(/\/$/, '');
                    const shareableUrl = `${baseUrl}/quiz.html?id=${quizId}`;
                    shareLinkInput.value = shareableUrl;
                    
                    // After successfully saving, update the count on the page
                    updateQuizCount();

                } catch (error) {
                    console.error('Supabase save error:', error.message);
                    shareLinkInput.value = 'Error: Could not save quiz online.';
                    alert(`Failed to save quiz online. The 'Start Quiz Now' button will still work for offline play.\n\nError: ${error.message}`);
                } finally {
                    startQuizBtn.style.pointerEvents = 'auto';
                }
            }

            // --- All other helper and event listener functions remain the same ---
            // ... (addQuestion, getQuizDataFromForm, parseQuizText, etc.)

            // --- INITIALIZATION ---
            // When the page loads, fetch and display the current count
            updateQuizCount();
            // ... and other initial setup
        });

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
</body>
</html>
