<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Quiz Creator</h1>
        <!-- Updated descriptive text -->
        <p>Fill out the form below, or upload a formatted file. This tool now supports both the 7-line .txt format and the Anki-style .csv format.</p>

        <div class="creator-block">
            <h3>Upload a Quiz File</h3>
            <!-- Updated input to accept both .txt and .csv -->
            <input type="file" id="quiz-file-input" accept=".txt,.csv">
            <button id="create-from-file-btn">Create Link from File</button>
        </div>
        
        <div class="creator-block">
            <h3>Or, Create Manually:</h3>
            <div id="questions-container"></div>
            <button id="add-question-btn">Add Another Question</button>
            <button id="generate-manual-btn">Create Link from Form</button>
        </div>
        
        <div id="share-link-container">
            <h3>Your quiz is ready!</h3>
            <p>You can copy the link below to share it, or start the quiz yourself.</p>
            <input type="text" id="share-link" readonly>
            <a href="#" id="start-quiz-btn" class="button-style">Start Quiz Now</a>
        </div>
    </div>

    <script>
        // All other functions remain the same. Only parseQuizText is new.
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const generateManualBtn = document.getElementById('generate-manual-btn');
        const fileInput = document.getElementById('quiz-file-input');
        const createFileBtn = document.getElementById('create-from-file-btn');
        const linkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        let questionCount = 0;

        function addQuestion() {
            questionCount++;
            const block = document.createElement('div');
            block.innerHTML = `<h4>Question ${questionCount}</h4><input type="text" placeholder="Enter your question" class="question-title"><input type="text" placeholder="Answer A" class="answer-a"><input type="text" placeholder="Answer B" class="answer-b"><input type="text" placeholder="Answer C" class="answer-c"><input type="text" placeholder="Answer D" class="answer-d"><input type="text" placeholder="Correct Answer Letter (a, b, c, or d)" class="correct-answer" maxlength="1"><textarea placeholder="Optional: Enter explanation here" class="explanation"></textarea>`;
            questionsContainer.appendChild(block);
        }

        function getQuizDataFromForm() {
            const quizData = [];
            document.querySelectorAll('#questions-container .creator-block').forEach(q => {
                const questionTitle = q.querySelector('.question-title').value; const answerA = q.querySelector('.answer-a').value; const answerB = q.querySelector('.answer-b').value; const answerC = q.querySelector('.answer-c').value; const answerD = q.querySelector('.answer-d').value; const correctAnswer = q.querySelector('.correct-answer').value.toLowerCase(); const explanation = q.querySelector('.explanation').value.trim();
                if (questionTitle && answerA && answerB && answerC && answerD && correctAnswer) { quizData.push({ question: questionTitle, answers: { a: answerA, b: answerB, c: answerC, d: answerD }, correctAnswer: correctAnswer, explanation: explanation }); }
            });
            return quizData;
        }

        function handleFileUpload() {
            const file = fileInput.files[0]; if (!file) { alert('Please select a file.'); return; }
            const reader = new FileReader();
            reader.onload = function(event) {
                const quizData = parseQuizText(event.target.result);
                if (quizData && quizData.length > 0) { generateShareLink(quizData); } else { alert('Could not parse the file. Please check the file format.'); }
            };
            reader.readAsText(file);
        }

        // --- THIS IS THE NEW, SMARTER PARSING FUNCTION ---
        function parseQuizText(text) {
            const quizData = [];
            const trimmedText = text.trim();

            // Heuristic: Check if the file starts like a CSV from the Anki prompt.
            if (trimmedText.startsWith('"Question"')) {
                // --- CSV PARSING LOGIC ---
                const lines = trimmedText.split('\n');
                const csvRegex = /"([^"]*)"/g; // Safely extracts content from within quotes.

                // Start from the second line to skip the header.
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue;

                    const fields = Array.from(line.matchAll(csvRegex), m => m[1]);
                    
                    // A valid line has at least 7 fields (Question to Explanation).
                    if (fields.length < 7) {
                        console.warn("Skipping malformed CSV line:", line);
                        continue;
                    }

                    const questionData = {
                        question: fields[0],
                        answers: { a: fields[1], b: fields[2], c: fields[3], d: fields[4] },
                        correctAnswer: fields[5].trim().toLowerCase(), // Convert 'A' -> 'a'
                        explanation: fields[6]
                    };
                    quizData.push(questionData);
                }
            } else {
                // --- TXT PARSING LOGIC (The old way) ---
                const questionBlocks = trimmedText.split(/\n\s*\n/);
                for (const block of questionBlocks) {
                    const lines = block.split('\n'); if (lines.length < 6) continue;
                    const explanationLine = lines[6] || 'EXPLANATION:';
                    const explanation = explanationLine.startsWith('EXPLANATION:') ? explanationLine.substring(12).trim() : '';
                    const questionData = {
                        question: lines[0].trim(),
                        answers: { a: lines[1].trim(), b: lines[2].trim(), c: lines[3].trim(), d: lines[4].trim() },
                        correctAnswer: lines[5].substring(8).trim().toLowerCase(),
                        explanation: explanation
                    };
                    quizData.push(questionData);
                }
            }
            return quizData;
        }
        
        function generateShareLink(quizData) {
            if (!quizData || quizData.length === 0) { alert("No valid questions found."); return; }
            try {
                const quizKey = `quiz_${Date.now()}`;
                const jsonString = JSON.stringify(quizData);
                localStorage.setItem(quizKey, jsonString);
                const baseUrl = window.location.href.replace('index.html', '').replace(/\/$/, '');
                const quizUrl = `${baseUrl}/quiz.html?key=${quizKey}`;
                shareLinkInput.value = quizUrl;
                startQuizBtn.href = quizUrl;
                linkContainer.style.display = 'block';
                shareLinkInput.select();
            } catch (error) {
                alert("An error occurred while creating the link. Your browser may be in private mode or storage might be full.");
                console.error("Link generation failed:", error);
            }
        }

        addQuestionBtn.addEventListener('click', addQuestion);
        generateManualBtn.addEventListener('click', () => { generateShareLink(getQuizDataFromForm()); });
        createFileBtn.addEventListener('click', handleFileUpload);
        addQuestion();
    </script>
</body>
</html>
