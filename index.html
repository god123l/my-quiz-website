<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creator</title>
    <meta name="theme-color" content="#4285f4"/>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Menu HTML -->
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="overlay" id="overlay"></div>
    <nav class="nav-panel" id="nav-panel">
        <ul>
            <li><a href="./how-to.html">How to Create a File?</a></li>
            <li><a href="https://360pwatcher.github.io/Anilist/" target="_blank">Contact Us</a></li>
        </ul>
    </nav>
    
    <main>
        <!-- Section 1: Hero Landing Page -->
        <div id="hero-section" class="hero-section">
            <div class="hero-content">
                <h1>CREATE A QUIZ</h1>
                <p>Build your own interactive quizzes with ease.</p>
                <a href="#" id="show-creator-btn" class="button-style">Create Quiz</a>
            </div>
            <img src="./hero-image.svg" alt="Quiz illustration" class="hero-image">
            <div id="quiz-counter-display" style="margin-top: 2rem; color: var(--secondary-text-color);"><span id="total-quizzes">...</span> quizzes created so far!</div>
        </div>
        
        <!-- Section 2: Creator Tools (starts hidden) -->
        <div id="creator-section" style="display: none;">
            <div class="container">
                <h1>Quiz Creator</h1>
                <p>Fill out the form below, or upload a formatted file.</p>
                <div class="creator-block">
                    <h3>Upload a Quiz File</h3>
                    <input type="file" id="quiz-file-input" accept=".txt,.csv">
                    <button id="create-from-file-btn">Create Link from File</button>
                </div>
                <div class="creator-block">
                    <h3>Or, Create Manually:</h3>
                    <div id="questions-container"></div>
                    <button id="add-question-btn">Add Another Question</button>
                    <button id="generate-manual-btn">Create Link from Form</button>
                </div>
                <div id="share-link-container" style="display: none;">
                    <h3>Your quiz is ready!</h3>
                    <p>Copy the link to share, or start the quiz directly on this device (works offline).</p>
                    <input type="text" id="share-link" readonly>
                    <a href="#" id="start-quiz-btn" class="button-style">Start Quiz Now</a>
                </div>
            </div>
        </div>

        <!-- Section 3: Quiz Player (starts hidden) -->
        <div id="quiz-view" style="display: none;">
            <div class="container">
                <div id="quiz-header"><h2 id="question-counter"></h2><div id="timer">0s</div></div>
                <div class="question-block"><div class="question" id="question-text"></div><div class="answers" id="answer-options"></div></div>
                <div id="explanation-box" style="display: none;"><h3>Explanation</h3><p id="explanation-text"></p></div>
                <button id="submit-btn">Submit Answer</button><button id="next-btn" style="display: none;">Next Question</button>
            </div>
        </div>

        <!-- Section 4: Results View (starts hidden) -->
        <div id="results-view" style="display: none;">
            <div class="container">
                <h2>Quiz Complete!</h2><p id="final-score"></p><p id="total-time"></p><h3>Performance Summary</h3>
                <div id="results-summary"></div><a href="./index.html" class="button-style secondary-button">Create a New Quiz</a>
            </div>
        </div>
    </main>

    <!-- THE SINGLE, COMPLETE, AND CORRECTED SCRIPT BLOCK -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SUPABASE SETUP ---
            const supabaseUrl = 'https://ptkyeeliwinrrkbvakau.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0a3llZWxpd2lucnJrYnZha2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzM5NTEsImV4cCI6MjA2NzIwOTk1MX0.81-re4H_ubzxSM16dyPvlZwHG8iKvrDoDPV34TKbDEo';
            const { createClient } = window.supabase;
            const supabase = createClient(supabaseUrl, supabaseKey);

            // --- DOM ELEMENT REFERENCES ---
            const heroSection = document.getElementById('hero-section');
            const creatorSection = document.getElementById('creator-section');
            const quizView = document.getElementById('quiz-view');
            const resultsView = document.getElementById('results-view');
            const showCreatorBtn = document.getElementById('show-creator-btn');
            const questionsContainer = document.getElementById('questions-container');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const generateManualBtn = document.getElementById('generate-manual-btn');
            const fileInput = document.getElementById('quiz-file-input');
            const createFileBtn = document.getElementById('create-from-file-btn');
            const linkContainer = document.getElementById('share-link-container');
            const shareLinkInput = document.getElementById('share-link');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const menuToggle = document.getElementById('menu-toggle');
            const navPanel = document.getElementById('nav-panel');
            const overlay = document.getElementById('overlay');
            const body = document.body;

            // --- GLOBAL STATE ---
            let quizData = [];
            
            // --- MENU LOGIC ---
            function closeMenu() {
                menuToggle.classList.remove('is-active');
                navPanel.classList.remove('open');
                overlay.classList.remove('open');
                body.classList.remove('no-scroll');
            }
            menuToggle.addEventListener('click', () => {
                menuToggle.classList.toggle('is-active');
                navPanel.classList.toggle('open');
                overlay.classList.toggle('open');
                body.classList.toggle('no-scroll');
            });
            overlay.addEventListener('click', closeMenu);

            // --- VIEW SWITCHING LOGIC ---
            showCreatorBtn.addEventListener('click', (e) => {
                e.preventDefault();
                heroSection.style.display = 'none';
                creatorSection.style.display = 'block';
            });

            // --- COUNTER LOGIC ---
            const countApiUrl = 'https://api.countapi.xyz';
            const namespace = 'god123l-quiz-creator';
            const key = 'creations';
            function updateQuizCount() {
                fetch(`${countApiUrl}/get/${namespace}/${key}`).then(res => res.json()).then(data => {
                    document.getElementById('total-quizzes').textContent = data.value || 0;
                }).catch(() => { document.getElementById('total-quizzes').textContent = 'N/A'; });
            }
            function incrementQuizCount() {
                fetch(`${countApiUrl}/hit/${namespace}/${key}`).then(res => res.json()).then(data => {
                    document.getElementById('total-quizzes').textContent = data.value;
                });
            }

            // --- QUIZ CREATOR FUNCTIONS ---
            let questionCount = 0;
            function addQuestion() {
                questionCount++;
                const block = document.createElement('div');
                block.className = 'manual-question-block';
                block.innerHTML = `<h4>Question ${questionCount}</h4><input type="text" placeholder="Enter your question" class="question-title"><input type="text" placeholder="Answer A" class="answer-a"><input type="text" placeholder="Answer B" class="answer-b"><input type="text" placeholder="Answer C" class="answer-c"><input type="text" placeholder="Answer D" class="answer-d"><input type="text" placeholder="Correct Answer Letter (a, b, c, or d)" class="correct-answer" maxlength="1"><textarea placeholder="Optional: Enter explanation here" class="explanation"></textarea>`;
                questionsContainer.appendChild(block);
            }
            function getQuizDataFromForm() {
                const data = [];
                document.querySelectorAll('.manual-question-block').forEach(qBlock => {
                    const questionTitle = qBlock.querySelector('.question-title').value;
                    const answerA = qBlock.querySelector('.answer-a').value;
                    const answerB = qBlock.querySelector('.answer-b').value;
                    const answerC = qBlock.querySelector('.answer-c').value;
                    const answerD = qBlock.querySelector('.answer-d').value;
                    const correctAnswer = qBlock.querySelector('.correct-answer').value.toLowerCase();
                    const explanation = qBlock.querySelector('.explanation').value.trim();
                    if (questionTitle && answerA && answerB && answerC && answerD && correctAnswer) {
                        data.push({ question: questionTitle, answers: { a: answerA, b: answerB, c: answerC, d: answerD }, correctAnswer: correctAnswer, explanation: explanation });
                    }
                });
                return data;
            }
            function handleFileUpload() {
                const file = fileInput.files[0];
                if (!file) { alert('Please select a file.'); return; }
                const reader = new FileReader();
                reader.onload = function(event) {
                    const data = parseQuizText(event.target.result);
                    if (data && data.length > 0) {
                        generateAndSaveQuiz(data);
                    } else { alert('Could not parse the file. Please check the file format.'); }
                };
                reader.readAsText(file);
            }
            // THIS IS THE CORRECTED FUNCTION
            function parseQuizText(text) {
                const data = []; const trimmedText = text.trim();
                if (trimmedText.startsWith('"Question"')) {
                    const lines = trimmedText.split('\n'); const csvRegex = /"([^"]*)"/g;
                    for (let i = 1; i < lines.length; i++) { const fields = Array.from(lines[i].matchAll(csvRegex), m => m[1]); if (fields.length < 7) continue; data.push({ question: fields[0], answers: { a: fields[1], b: fields[2], c: fields[3], d: fields[4] }, correctAnswer: fields[5].trim().toLowerCase(), explanation: fields[6] }); }
                } else if (trimmedText.includes('\t')) {
                    const lines = trimmedText.split('\n');
                    for (const line of lines) { if (line.startsWith('#') || !line.trim()) continue; const fields = line.split('\t'); if (fields.length < 7) continue; data.push({ question: fields[0], answers: { a: fields[1], b: fields[2], c: fields[3], d: fields[4] }, correctAnswer: fields[5].trim().toLowerCase(), explanation: fields[6] }); }
                } else {
                    const questionBlocks = trimmedText.split(/\n\s*\n/);
                    for (const block of questionBlocks) {
                        const lines = block.split('\n'); if (lines.length < 6) continue;
                        const explanationLine = lines[6] || 'EXPLANATION:';
                        const explanation = explanationLine.startsWith('EXPLANATION:') ? explanationLine.substring(12).trim() : '';
                        // THE FIX IS HERE: I have added 'd: lines[4].trim()'
                        data.push({
                            question: lines[0].trim(),
                            answers: { a: lines[1].trim(), b: lines[2].trim(), c: lines[3].trim(), d: lines[4].trim() },
                            correctAnswer: lines[5].substring(8).trim().toLowerCase(),
                            explanation: explanation
                        });
                    }
                }
                return data;
            }
            async function generateAndSaveQuiz(data) {
                quizData = data;
                if (!quizData || quizData.length === 0) { alert("No valid questions found."); return; }
                incrementQuizCount();
                const quizId = Date.now().toString(36) + Math.random().toString(36).substring(2, 7);
                shareLinkInput.value = 'Saving to cloud...';
                linkContainer.style.display = 'block';
                const { error } = await supabase.from('quizzes').insert({ short_id: quizId, data: quizData });
                if (error) {
                    console.error('Error saving to Supabase:', error);
                    shareLinkInput.value = 'Error: Could not save quiz.';
                    return;
                }
                const baseUrl = window.location.href.replace('index.html', '').replace(/\/$/, '');
                const shareableUrl = `${baseUrl}/quiz.html?id=${quizId}`;
                shareLinkInput.value = shareableUrl;
            }
            startQuizBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (quizData && quizData.length > 0) {
                    creatorSection.style.display = 'none';
                    heroSection.style.display = 'none';
                    startQuiz(quizData);
                } else { alert("Please generate a quiz first before starting."); }
            });
            addQuestionBtn.addEventListener('click', addQuestion);
            generateManualBtn.addEventListener('click', () => {
                const dataFromForm = getQuizDataFromForm();
                if(dataFromForm.length > 0) generateAndSaveQuiz(dataFromForm);
                else alert("Please fill out at least one question completely.");
            });
            createFileBtn.addEventListener('click', handleFileUpload);
            
            // --- FULL QUIZ PLAYER LOGIC ---
            let currentQIndex = 0; let score = 0; let userAnswers = []; let timePerQuestion = []; let timerInterval; let questionStartTime;
            function startQuiz(data) {
                const quizView = document.getElementById('quiz-view');
                const resultsView = document.getElementById('results-view');
                quizData = data; currentQIndex = 0; score = 0; userAnswers = []; timePerQuestion = [];
                quizView.style.display = 'block';
                resultsView.style.display = 'none';
                quizView.innerHTML = `<div class="container"><div id="quiz-header"><h2 id="question-counter"></h2><div id="timer">0s</div></div><div class="question-block"><div class="question" id="question-text"></div><div class="answers" id="answer-options"></div></div><div id="explanation-box" style="display: none;"><h3>Explanation</h3><p id="explanation-text"></p></div><button id="submit-btn">Submit Answer</button><button id="next-btn" style="display: none;">Next Question</button></div>`;
                displayQuestion();
            }
            function startTimer() {
                const timerDisplay = document.getElementById('timer');
                questionStartTime = Date.now();
                timerInterval = setInterval(() => { timerDisplay.textContent = `${Math.floor((Date.now() - questionStartTime) / 1000)}s`; }, 1000);
            }
            function stopTimer() {
                clearInterval(timerInterval);
                timePerQuestion.push(Math.round((Date.now() - questionStartTime) / 1000));
            }
            function displayQuestion() {
                const qCounter = document.getElementById('question-counter');
                const qText = document.getElementById('question-text');
                const answerOpts = document.getElementById('answer-options');
                const explanationBox = document.getElementById('explanation-box');
                const submitBtn = document.getElementById('submit-btn');
                const nextBtn = document.getElementById('next-btn');

                explanationBox.style.display = 'none';
                submitBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                answerOpts.innerHTML = '';
                const currentQ = quizData[currentQIndex];
                qCounter.textContent = `Question ${currentQIndex + 1} of ${quizData.length}`;
                qText.textContent = currentQ.question;
                for (const letter in currentQ.answers) {
                    const label = document.createElement('label');
                    const answerText = currentQ.answers[letter];
                    label.innerHTML = `<input type="radio" name="answer" value="${letter}">`;
                    label.appendChild(document.createTextNode(` ${letter.toUpperCase()}: ${answerText}`));
                    answerOpts.appendChild(label);
                }
                if (window.MathJax) { MathJax.typeset(); }
                startTimer();
            }
            document.body.addEventListener('click', function(e) {
                if(e.target && e.target.id == 'submit-btn') {
                    const answerOpts = document.getElementById('answer-options');
                    const selectedRadio = answerOpts.querySelector('input[name="answer"]:checked');
                    if (!selectedRadio) { alert('Please select an answer!'); return; }
                    stopTimer();
                    const userAnswer = selectedRadio.value; const currentQ = quizData[currentQIndex]; userAnswers.push(userAnswer);
                    answerOpts.querySelectorAll('input').forEach(input => input.disabled = true);
                    const correctLabel = answerOpts.querySelector(`input[value="${currentQ.correctAnswer}"]`).parentElement;
                    correctLabel.classList.add('correct');
                    if (userAnswer === currentQ.correctAnswer) { score++; } else { selectedRadio.parentElement.classList.add('incorrect'); }
                    const explanationBox = document.getElementById('explanation-box'); const explanationText = document.getElementById('explanation-text');
                    if (currentQ.explanation) {
                        explanationText.textContent = currentQ.explanation;
                        explanationBox.style.display = 'block';
                        if (window.MathJax) { MathJax.typesetPromise([explanationBox]).catch((err) => console.log(err.message)); }
                    }
                    e.target.style.display = 'none';
                    document.getElementById('next-btn').style.display = 'inline-block';
                    if (currentQIndex === quizData.length - 1) { document.getElementById('next-btn').textContent = 'Show Results'; }
                }
                if(e.target && e.target.id == 'next-btn') {
                    currentQIndex++;
                    if (currentQIndex < quizData.length) { displayQuestion(); } else { displayResults(); }
                }
            });
            function displayResults() {
                const quizView = document.getElementById('quiz-view');
                const resultsView = document.getElementById('results-view');
                quizView.style.display = 'none';
                resultsView.style.display = 'block';
                const finalScoreEl = document.getElementById('final-score');
                const totalTimeEl = document.getElementById('total-time');
                const summaryEl = document.getElementById('results-summary');
                
                finalScoreEl.textContent = `Final Score: ${score} out of ${quizData.length}`;
                const totalTime = timePerQuestion.reduce((a, b) => a + b, 0);
                totalTimeEl.textContent = `Total Time: ${totalTime} seconds`;
                let summaryHtml = '<table><tr><th>#</th><th>Question</th><th>Your Answer</th><th>Time</th></tr>';
                quizData.forEach((q, i) => {
                    const isCorrect = userAnswers[i] === q.correctAnswer;
                    const statusClass = isCorrect ? 'result-correct' : 'result-incorrect';
                    const statusSymbol = isCorrect ? '✔' : '✖';
                    const userAnswerText = `${userAnswers[i] ? userAnswers[i].toUpperCase() : 'N/A'}: ${userAnswers[i] ? q.answers[userAnswers[i]] : 'No Answer'}`;
                    const correctAnswerText = `Correct: ${q.correctAnswer.toUpperCase()}: ${q.answers[q.correctAnswer]}`;
                    summaryHtml += `<tr><td class="${statusClass}">${statusSymbol}</td><td>${q.question}</td><td>${userAnswerText} <br><small class="${statusClass}">${isCorrect ? '' : correctAnswerText}</small></td><td>${timePerQuestion[i]}s</td></tr>`;
                });
                summaryHtml += '</table>';
                summaryEl.innerHTML = summaryHtml;
                if (window.MathJax) { MathJax.typesetPromise([resultsView]).catch((err) => console.log(err.message)); }
            }

            // --- INITIALIZATION ---
            updateQuizCount();
            addQuestion();
        });

        // --- PWA REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
</body>
</html>