<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome Quiz</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="quiz-view">
        <div id="quiz-header">
            <h2 id="question-counter"></h2>
            <div id="timer">0s</div>
        </div>
        <div class="question-block">
            <div class="question" id="question-text"></div>
            <div class="answers" id="answer-options"></div>
        </div>
        <div id="explanation-box" style="display: none;">
            <h3>Explanation</h3>
            <p id="explanation-text"></p>
        </div>
        <button id="submit-btn">Submit Answer</button>
        <button id="next-btn" style="display: none;">Next Question</button>
    </div>

    <div id="results-view" style="display: none;">
        <h2>Quiz Complete!</h2>
        <p id="final-score"></p>
        <p id="total-time"></p>
        <h3>Performance Summary</h3>
        <div id="results-summary"></div>
        <a href="index.html" class="button-style">Create a New Quiz</a>
    </div>

    <div id="error-container" style="display: none;">
        <h1>Oops!</h1>
        <p>No quiz data found. Please make sure you are using a valid link.</p>
        <a href="index.html">Create a new quiz</a>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const quizView = document.getElementById('quiz-view');
        const resultsView = document.getElementById('results-view');
        const errorContainer = document.getElementById('error-container');
        const qCounter = document.getElementById('question-counter');
        const timerDisplay = document.getElementById('timer');
        const qText = document.getElementById('question-text');
        const answerOpts = document.getElementById('answer-options');
        const explanationBox = document.getElementById('explanation-box');
        const explanationText = document.getElementById('explanation-text');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');

        // State
        let quizData = [];
        let currentQIndex = 0;
        let score = 0;
        let userAnswers = [];
        let timePerQuestion = [];
        let timerInterval;
        let questionStartTime;

        function startTimer() {
            questionStartTime = Date.now();
            timerInterval = setInterval(() => {
                const seconds = Math.floor((Date.now() - questionStartTime) / 1000);
                timerDisplay.textContent = `${seconds}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = Date.now();
            const timeTaken = Math.round((endTime - questionStartTime) / 1000);
            timePerQuestion.push(timeTaken);
        }

        function displayQuestion() {
            // Reset state
            explanationBox.style.display = 'none';
            submitBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            answerOpts.innerHTML = '';

            const currentQ = quizData[currentQIndex];
            qCounter.textContent = `Question ${currentQIndex + 1} of ${quizData.length}`;
            qText.textContent = currentQ.question;

            for (const letter in currentQ.answers) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="radio" name="answer" value="${letter}"> ${letter.toUpperCase()}: ${currentQ.answers[letter]}`;
                answerOpts.appendChild(label);
            }
            startTimer();
        }

        submitBtn.addEventListener('click', function() {
            const selectedRadio = answerOpts.querySelector('input[name="answer"]:checked');
            if (!selectedRadio) {
                alert('Please select an answer!');
                return;
            }

            stopTimer();
            const userAnswer = selectedRadio.value;
            const currentQ = quizData[currentQIndex];
            userAnswers.push(userAnswer);

            // Disable all inputs
            answerOpts.querySelectorAll('input').forEach(input => input.disabled = true);
            
            const correctLabel = answerOpts.querySelector(`input[value="${currentQ.correctAnswer}"]`).parentElement;
            correctLabel.classList.add('correct');

            if (userAnswer === currentQ.correctAnswer) {
                score++;
            } else {
                selectedRadio.parentElement.classList.add('incorrect');
            }

            if (currentQ.explanation) {
                explanationText.textContent = currentQ.explanation;
                explanationBox.style.display = 'block';
            }

            submitBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            if (currentQIndex === quizData.length - 1) {
                nextBtn.textContent = 'Show Results';
            }
        });

        nextBtn.addEventListener('click', function() {
            currentQIndex++;
            if (currentQIndex < quizData.length) {
                displayQuestion();
            } else {
                displayResults();
            }
        });

        function displayResults() {
            quizView.style.display = 'none';
            resultsView.style.display = 'block';

            document.getElementById('final-score').textContent = `Final Score: ${score} out of ${quizData.length}`;
            const totalTime = timePerQuestion.reduce((a, b) => a + b, 0);
            document.getElementById('total-time').textContent = `Total Time: ${totalTime} seconds`;

            let summaryHtml = '<table><tr><th>#</th><th>Question</th><th>Your Answer</th><th>Time</th></tr>';
            quizData.forEach((q, i) => {
                const isCorrect = userAnswers[i] === q.correctAnswer;
                const statusClass = isCorrect ? 'result-correct' : 'result-incorrect';
                const statusSymbol = isCorrect ? '✔' : '✖';
                const userAnswerText = `${userAnswers[i].toUpperCase()}: ${q.answers[userAnswers[i]]}`;
                const correctAnswerText = `Correct: ${q.correctAnswer.toUpperCase()}: ${q.answers[q.correctAnswer]}`;
                
                summaryHtml += `
                    <tr>
                        <td class="${statusClass}">${statusSymbol}</td>
                        <td>${q.question}</td>
                        <td>${userAnswerText} <br><small class="${statusClass}">${isCorrect ? '' : correctAnswerText}</small></td>
                        <td>${timePerQuestion[i]}s</td>
                    </tr>
                `;
            });
            summaryHtml += '</table>';
            document.getElementById('results-summary').innerHTML = summaryHtml;
        }

        // --- Initialization ---
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (!encodedData) throw new Error("No data in URL");

            const jsonString = decodeURIComponent(escape(atob(encodedData)));
            quizData = JSON.parse(jsonString);
            
            if (quizData.length > 0) displayQuestion();
            else throw new Error("Quiz data is empty");

        } catch (e) {
            console.error("Initialization failed:", e);
            quizView.style.display = 'none';
            errorContainer.style.display = 'block';
        }
    });
    </script>
</body>
</html>
