<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome Quiz</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="quiz-body">
        <h1>Quiz Time!</h1>
        <div id="quiz-container"></div>
        <button id="submit-button">Submit Answers</button>
        <div id="results-container"></div>
    </div>
    
    <div id="error-container" style="display: none;">
        <h1>Oops!</h1>
        <p>No quiz data was found. Please make sure you are using a valid link created from the quiz generator.</p>
        <a href="index.html">Create a new quiz</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quizBody = document.getElementById('quiz-body');
            const errorContainer = document.getElementById('error-container');
            const quizContainer = document.getElementById('quiz-container');
            const resultsContainer = document.getElementById('results-container');
            const submitButton = document.getElementById('submit-button');

            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            let quizData = []; // Define quizData here to be accessible in all functions

            if (!encodedData) {
                quizBody.style.display = 'none';
                errorContainer.style.display = 'block';
                return;
            }

            try {
                const jsonString = atob(encodedData);
                quizData = JSON.parse(jsonString); // Assign the parsed data

                function buildQuiz() {
                    const output = [];
                    quizData.forEach((currentQuestion, questionNumber) => {
                        const answers = [];
                        for (letter in currentQuestion.answers) {
                            answers.push(
                                `<label>
                                    <input type="radio" name="question${questionNumber}" value="${letter}">
                                    ${letter} : ${currentQuestion.answers[letter]}
                                </label>`
                            );
                        }
                        output.push(
                            `<div class="question-block">
                                <div class="question"> ${currentQuestion.question} </div>
                                <div class="answers"> ${answers.join('')} </div>
                            </div>`
                        );
                    });
                    quizContainer.innerHTML = output.join('');
                }

                // --- THIS IS THE UPDATED FUNCTION ---
                function showResults() {
                    // Hide the submit button and disable all radio inputs
                    submitButton.style.display = 'none';
                    const allRadios = quizContainer.querySelectorAll('input[type="radio"]');
                    allRadios.forEach(radio => radio.disabled = true);

                    const answerContainers = quizContainer.querySelectorAll('.answers');
                    let numCorrect = 0;

                    quizData.forEach((currentQuestion, questionNumber) => {
                        const answerContainer = answerContainers[questionNumber];
                        const selector = `input[name=question${questionNumber}]:checked`;
                        const userAnswerNode = answerContainer.querySelector(selector);
                        const userAnswer = userAnswerNode ? userAnswerNode.value : undefined;

                        // Find the label for the correct answer
                        const correctLabel = answerContainer.querySelector(`input[value=${currentQuestion.correctAnswer}]`).parentElement;
                        
                        // Always highlight the correct answer in green
                        correctLabel.classList.add('correct');

                        // If the user answered and was correct
                        if (userAnswer === currentQuestion.correctAnswer) {
                            numCorrect++;
                        } 
                        // If the user answered but was incorrect
                        else if (userAnswer !== undefined) {
                            userAnswerNode.parentElement.classList.add('incorrect');
                        }
                    });

                    // Update the final score text
                    resultsContainer.innerHTML = `You got ${numCorrect} out of ${quizData.length} correct!`;
                }

                buildQuiz();
                submitButton.addEventListener('click', showResults);

            } catch (e) {
                console.error("Failed to parse quiz data:", e);
                quizBody.style.display = 'none';
                errorContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>
